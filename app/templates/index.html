{% extends "base.html" %}

{% block title %}MommyData - NSW Mothers and Babies Data Explorer{% endblock %}

{% block content %}
<div class="text-center mb-12">
    <h1 class="text-4xl sm:text-5xl md:text-6xl font-hand font-bold text-black mb-4">
        Mom's health comes first
    </h1>
    <p class="text-lg text-secondary max-w-2xl mx-auto">
        Enter your age and select a factor to compare with historical data and see your situation. (Australia 2018-2023)
    </p>
</div>

<div class="max-w-4xl mx-auto">
    <!-- Age and Factor Selection -->
    <div class="mb-12 max-w-3xl mx-auto">
        <!-- Age Input -->
        <div class="bg-white border-2 border-black rounded-lg p-6 mb-4">
            <label class="block text-sm font-sans font-bold text-black mb-2">Your Age</label>
            <input 
                type="number" 
                id="userAge" 
                min="15" 
                max="50" 
                placeholder="Enter your age"
                class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black font-sans"
            />
        </div>
        
        <!-- Factor Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button 
                onclick="selectFactor('diabetes')" 
                id="btn-diabetes"
                class="factor-btn bg-white border-2 border-black rounded-lg p-6 hover:shadow-lg transition-all cursor-pointer text-center"
            >
                <div class="text-3xl mb-2">ðŸ©º</div>
                <h3 class="text-lg font-hand font-bold text-black">Diabetes</h3>
            </button>
            
            <button 
                onclick="selectFactor('hypertension')" 
                id="btn-hypertension"
                class="factor-btn bg-white border-2 border-black rounded-lg p-6 hover:shadow-lg transition-all cursor-pointer text-center"
            >
                <div class="text-3xl mb-2">ðŸ’Š</div>
                <h3 class="text-lg font-hand font-bold text-black">Hypertension</h3>
            </button>
        </div>
    </div>

    <!-- User Selection Form -->
    <div id="selectionForm" class="hidden bg-white border-2 border-black rounded-lg p-6 sm:p-8 mb-8">
        <h2 id="formTitle" class="text-2xl font-hand font-bold text-black mb-4"></h2>
        <div id="formContent"></div>
    </div>

    <!-- Chart Display -->
    <div id="chartSection" class="hidden">
        <div class="bg-white border-2 border-black rounded-lg p-6 sm:p-8">
            <h2 id="chartTitle" class="text-2xl font-hand font-bold text-black mb-6"></h2>
            <div class="flex justify-center mb-6">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
        <p class="mt-2 text-secondary">Loading...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentFactor = null;
    let currentAge = null;
    let currentYears = null;
    let lineChart = null;

    function selectFactor(factor) {
        currentFactor = factor;
        
        // Reset all buttons
        document.querySelectorAll('.factor-btn').forEach(btn => {
            btn.classList.remove('bg-black', 'text-white');
            btn.classList.add('bg-white', 'border-black');
        });
        
        // Highlight selected button
        const btn = document.getElementById(`btn-${factor}`);
        btn.classList.remove('bg-white', 'border-black');
        btn.classList.add('bg-black', 'text-white');
        
        // Show selection form
        showSelectionForm(factor);
    }

    function showSelectionForm(factor) {
        const form = document.getElementById('selectionForm');
        const formTitle = document.getElementById('formTitle');
        const formContent = document.getElementById('formContent');
        
        formTitle.textContent = `View ${factor.charAt(0).toUpperCase() + factor.slice(1)} Trends by Age`;
        
        // Create end year options from 2023 down to 2018
        const endYearOptions = [];
        for (let y = 2023; y >= 2018; y--) {
            endYearOptions.push(`<option value="${y}">${y}</option>`);
        }
        
        // Define sub-group options for each factor
        const subGroupOptions = {
            diabetes: [
                { value: 'Pre-existing diabetes', label: 'Pre-existing diabetes' },
                { value: 'Gestational diabetes', label: 'Gestational diabetes' },
                { value: 'Diabetes - none', label: 'No diabetes' },
                { value: 'Diabetes - not stated', label: 'Not stated' }
            ],
            hypertension: [
                { value: 'Pre-existing hypertension', label: 'Pre-existing hypertension' },
                { value: 'Gestational hypertension', label: 'Gestational hypertension' },
                { value: 'Pre-eclampsia/eclampsia', label: 'Pre-eclampsia/eclampsia' },
                { value: 'Hypertension - none', label: 'No hypertension' },
                { value: 'Hypertension - not stated', label: 'Not stated' }
            ]
        };
        
        // Show sub-group options when factor is selected
        const subGroups = subGroupOptions[factor] || [];
        const subGroupOptionsHtml = subGroups.map(opt => 
            `<label class="flex items-center p-3 border-2 border-black rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                <input type="checkbox" value="${opt.value}" class="subgroup-checkbox mr-3 w-5 h-5 border-2 border-black rounded focus:ring-2 focus:ring-black" />
                <span class="font-sans">${opt.label}</span>
            </label>`
        ).join('');
        
        const html = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-sans font-bold text-black mb-2">2023 to which year?</label>
                    <select id="endYear" class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black font-sans">
                        ${endYearOptions.join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-sans font-bold text-black mb-2">Type (select one or more)</label>
                    <div class="space-y-2 max-h-64 overflow-y-auto border-2 border-black rounded-lg p-3">
                        ${subGroupOptionsHtml}
                    </div>
                </div>
                <button 
                    onclick="loadChart()" 
                    class="w-full bg-black text-white px-6 py-3 rounded-lg font-hand font-bold hover:opacity-90 transition-opacity"
                >
                    View Trends
                </button>
            </div>
        `;
        
        formContent.innerHTML = html;
        form.classList.remove('hidden');
        
        // Hide chart section
        document.getElementById('chartSection').classList.add('hidden');
    }

    function getAgeGroup(age) {
        if (age < 20) return 'Under 20';
        if (age >= 20 && age < 25) return '20-24';
        if (age >= 25 && age < 30) return '25-29';
        if (age >= 30 && age < 35) return '30-34';
        if (age >= 35 && age < 40) return '35-39';
        if (age >= 40) return '40 and over';
        return null;
    }
    

    async function loadChart() {
        const age = parseInt(document.getElementById('userAge').value);
        const endYear = parseInt(document.getElementById('endYear').value);
        const startYear = 2023; // Always start from 2023
        
        // Get selected sub-groups
        const checkboxes = document.querySelectorAll('.subgroup-checkbox:checked');
        const selectedSubGroups = Array.from(checkboxes).map(cb => cb.value);
        
        if (!age || age < 15 || age > 50) {
            alert('Please enter a valid age (15-50)');
            return;
        }
        
        if (!currentFactor) {
            alert('Please select a factor first');
            return;
        }
        
        if (selectedSubGroups.length === 0) {
            alert('Please select at least one type');
            return;
        }
        
        currentAge = age;
        const ageGroup = getAgeGroup(age);
        
        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('chartSection').classList.add('hidden');
        
        try {
            // Fetch detailed data (with sub-groups)
            const params = new URLSearchParams();
            params.append('age_group', ageGroup);
            params.append('start_year', startYear.toString());
            params.append('end_year', endYear.toString());
            selectedSubGroups.forEach(sg => {
                params.append('sub_group', sg);
            });
            
            const response = await fetch(`/api/v1/factor/${currentFactor}?${params.toString()}`);
            const data = await response.json();
            
            // Hide loading
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('chartSection').classList.remove('hidden');
            
            // Display chart
            displayChart(data, currentFactor, ageGroup, selectedSubGroups);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').classList.add('hidden');
            alert('Error loading data. Please try again later.');
        }
    }

    function displayChart(data, factor, userAgeGroup, selectedSubGroups = []) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        const chartTitle = document.getElementById('chartTitle');
        
        // Destroy existing chart
        if (lineChart) {
            lineChart.destroy();
        }
        
        // Prepare chart data
        const years = data.years || [];
        const ageGroups = data.age_groups || {};
        
        // ageGroups structure: {age_group: {sub_group: {year: percentage}}}
        // We need to create datasets for each age_group
        const datasets = [];
        const colors = ['#000000', '#4B5563', '#9CA3AF', '#D1D5DB', '#E5E7EB', '#F3F4F6'];
        
        // Get all age groups
        const allAgeGroups = Object.keys(ageGroups).sort();
        
        allAgeGroups.forEach((ageGroup, ageIndex) => {
            const isUserGroup = ageGroup === userAgeGroup;
            const subGroups = ageGroups[ageGroup] || {};
            
            // For each sub_group selected, create a line
            // If multiple sub_groups selected, we need to aggregate or show separately
            if (selectedSubGroups.length === 1) {
                // Single sub_group selected - show one line per age group
                const subGroup = selectedSubGroups[0];
                const subGroupData = subGroups[subGroup] || {};
                const values = years.map(year => subGroupData[year] || null);
                
                datasets.push({
                    label: ageGroup,
                    data: values,
                    borderColor: isUserGroup ? '#000000' : colors[ageIndex % colors.length],
                    backgroundColor: isUserGroup ? '#000000' : colors[ageIndex % colors.length],
                    borderWidth: isUserGroup ? 3 : 2,
                    borderDash: isUserGroup ? [] : [5, 5],
                    pointRadius: isUserGroup ? 5 : 3,
                    pointHoverRadius: isUserGroup ? 7 : 5,
                    tension: 0.1,
                });
            } else {
                // Multiple sub_groups selected - show one line per (age_group, sub_group) combination
                selectedSubGroups.forEach((subGroup, subIndex) => {
                    const subGroupData = subGroups[subGroup] || {};
                    const values = years.map(year => subGroupData[year] || null);
                    
                    // Only show if there's data for this sub_group
                    if (values.some(v => v !== null)) {
                        const label = selectedSubGroups.length > 1 ? `${ageGroup} (${subGroup})` : ageGroup;
                        const colorIndex = (ageIndex * selectedSubGroups.length + subIndex) % colors.length;
                        
                        datasets.push({
                            label: label,
                            data: values,
                            borderColor: isUserGroup ? '#000000' : colors[colorIndex],
                            backgroundColor: isUserGroup ? '#000000' : colors[colorIndex],
                            borderWidth: isUserGroup ? 3 : 2,
                            borderDash: isUserGroup ? [] : [5, 5],
                            pointRadius: isUserGroup ? 5 : 3,
                            pointHoverRadius: isUserGroup ? 7 : 5,
                            tension: 0.1,
                        });
                    }
                });
            }
        });
        
        chartTitle.textContent = `${factor.charAt(0).toUpperCase() + factor.slice(1)} Percentage by Age Group Over Time`;
        
        // Create chart
        lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: datasets,
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year',
                            font: {
                                family: 'Inter, system-ui, sans-serif',
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                family: 'Inter, system-ui, sans-serif'
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Percentage (%)',
                            font: {
                                family: 'Inter, system-ui, sans-serif',
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                family: 'Inter, system-ui, sans-serif'
                            },
                            precision: 1
                        },
                        beginAtZero: false,
                        grace: '10%'
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                family: 'Inter, system-ui, sans-serif'
                            },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                return `${label}: ${value !== null ? value.toFixed(1) + '%' : 'N/A'}`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}

